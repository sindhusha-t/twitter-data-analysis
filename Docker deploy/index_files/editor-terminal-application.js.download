var EditorTerminalView=function(){var js_view,term_view;this.init=function(terminalOptions){var tabbedView=new TabBarView;tabbedView.init();term_view=new TerminalViewLayout({tabview:tabbedView});var sync_editor_to_container=new SyncEditorToContainer(term_view);sync_editor_to_container.init();term_view.init(terminalOptions);js_view=new JsHtmlView;js_view.init()};this.execute=function(code){term_view.write(code)};this.setCode=function(code){js_view.setCode(code)};this.getCode=function(){js_view.getCode(code)};this.validate_step_change=function(step){if(js_view&&js_view.validate_step_change){js_view.validate_step_change(step)}if(term_view&&term_view.validate_step_change){term_view.validate_step_change(step)}};this.intro=function(id,step){if(term_view&&term_view.intro){term_view.intro(id,step)}};this.next_step=function(id,step){if(term_view&&term_view.next_step){term_view.next_step(id,step)}}};var JSTreeView=function(views){var TERMINAL_READY="terminal-ready-event";var element;var socket;var filesocket;var editors={};var watchers={};var data={};var currentTree;var options;this.init=function(_options){element=_options.tree;options=_options;document.addEventListener(TERMINAL_READY,watch);if(views===undefined||views.tabview===undefined){var tabbedView=new TabBarView;tabbedView.init()}$(".kfilebrowsertab-open .fa.fa-folder-open").click(function(e){e.preventDefault();$(".kfilebrowsertab-closed").removeClass("hidden");$("#jstree-container").addClass("hidden");$("#editor").removeClass("s10").addClass("s12");return false});$(".kfilebrowsertab-open .fa.fa-sync").click(function(e){e.preventDefault();if(filesocket)filesocket.emit("fs-refresh");return false});$(".kfilebrowsertab-open .fa.fa-angle-double-down").click(function(e){e.preventDefault();$(".kfilebrowsertab-open .fa.fa-angle-double-down").addClass("hidden");$(".kfilebrowsertab-open .fa.fa-angle-double-up").removeClass("hidden");$("#jstree").jstree("open_all");return false});$(".kfilebrowsertab-open .fa.fa-angle-double-up").click(function(e){e.preventDefault();$(".kfilebrowsertab-open .fa.fa-angle-double-up").addClass("hidden");$(".kfilebrowsertab-open .fa.fa-angle-double-down").removeClass("hidden");$("#jstree").jstree("close_all");$("#jstree").jstree("select_node","ul > li:first");var selectednode=$("#jstree").jstree("get_selected");$("#jstree").jstree("open_node",selectednode,false,true);return false});$(".kfilebrowsertab-closed").click(function(e){e.preventDefault();$(".kfilebrowsertab-closed").addClass("hidden");$("#jstree-container").removeClass("hidden");$("#editor").removeClass("s12").addClass("s10");return false});$("code.open").click(function(e){e.preventDefault();var path=$(this).text();openFile(path.replace(".","-"),path,"./"+path);return false})};var watch=function(e){var query;if(options&&options.socketBased&&window.course.view.project.hosts&&window.course.view.project.hosts.length>0){var subdomain=window.course.view.project.hosts[0].katacodahost.split("-")[0];var serverpath="/root";if(window.course.course&&window.course.course.environment&&window.course.course.environment.uieditorpath)serverpath=window.course.course.environment.uieditorpath;query="subdomain="+subdomain+"&serverpath="+serverpath;console.log("Creating....",query,getWSURL());filesocket=io.connect(getWSURL(),{transports:["websocket","polling"],timeout:120*1e3,reconnection:true});window.filesocket=filesocket;filesocket.on("connect_error",function(err){if(window.trackJs){trackJs.track("Cannot connect to file socket - Connect Error")}});filesocket.on("connect_timeout",function(err){if(window.trackJs){trackJs.track("Cannot connect to file socket - Connect Timeout")}});filesocket.on("error",function(err){if(window.trackJs){trackJs.track("Cannot connect to file socket - Error")}});filesocket.on("err",function(err){if(window.trackJs){trackJs.track("Cannot connect to file socket - Err")}})}else{socket=e.socket;filesocket=e.socket;query="serverpath="+serverpath}filesocket.on("fs-event",drawTree);filesocket.emit("fs-listen",query);filesocket.on("save-file-resp",function(evt){hideLoadFileProgress()});filesocket.on("fs-listen-err",function(evt){watch({socket:socket});if(window.trackJs){trackJs.track("fs-listen-err")}});filesocket.on("load-file-resp",function(evt){hideLoadFileProgress();try{evt.content=atob(evt.content)}catch(e){if(window.trackJs){trackJs.track("Error opening file: "+evt.file)}alert("Sorry, a problem occurred when processing the file. It's not possible to open this with the editor. As a workaround, try a command line editor like Vim.");console.log("File opening Error",evt.file,evt.content);$('.ktab.kfiletab[data-path="'+evt.file+'"]').remove();$(".ktab.kfiletab:first").click();$('#split-host .ace_editor[data-path="'+evt.file+'"]').remove();clearInterval(watchers[evt.file]);return}if(evt.content&&evt.content.indexOf("Error: File cannot be loaded")>=0){console.log("File Loading Error",evt.file,evt.content);if(window.trackJs){trackJs.track("Error: File cannot be loaded:"+evt.file)}$(".ktab.kfiletab:first").click();$('.ktab.kfiletab[data-path="'+evt.file+'"] a.tab-progress').addClass("hidden");$('#split-host .ace_editor[data-path="'+evt.file+'"]').remove();$('.ktabs .kfiletab[data-path="'+evt.file+'"]').remove();return}if(image(evt.file)){$('.ktab.kfiletab[data-path="'+evt.file+'"]').remove();if(course.course.backend.dockerimage==="r-tutorial-v1"||course.course.backend.dockerimage==="scrapbook-tensorflow"){var current=data[evt.file]||0;if(current!==evt.content.length){openImageTab(evt);data[evt.file]=evt.content.length}refresh(evt)}else{}}else{$('.ktab.kfiletab[data-path="'+evt.file+'"] a.tab-progress').addClass("hidden");var editor=editors[evt.file];if(editor){editor.set_code(evt.content,false)}}})};var refresh=function(evt){if(watchers[evt.file])return;var i=setInterval(function(){filesocket.emit("load-file",evt.file)},2500);watchers[evt.file]=i};var image=function(file){var f=file.toLowerCase();return f.indexOf(".pdf")>0||f.indexOf(".png")>0};var openImageTab=function(evt){var len=evt.content.length;var bytes=new Uint8Array(len);for(var i=0;i<len;i++){bytes[i]=evt.content.charCodeAt(i)}var contents=bytes.buffer;var html;if(evt.file.indexOf(".pdf")>0){var file=new Blob([contents],{type:"application/pdf"});var fileURL=URL.createObjectURL(file);html=Handlebars.templates["iframe.hbs"]({id:evt.file,src:fileURL,class:"hidden"})}else{html='<div class="image-displayer" id="'+evt.file+'" class="hidden" style="max-height: 100%; overflow: scroll"><img src="data:image/png;base64,'+btoa(evt.content)+'" style="max-height: 100%; max-width: 100%" /></div>'}var id=escapeSelector(evt.file);if(id.indexOf("#")===-1)id="#"+id;if($(id).length===0){var options={id:evt.file,filename:evt.file,name:evt.file};var newTab=Handlebars.templates["tab.hbs"](options);$(newTab).appendTo($("#split-host .split:last .tabbar .ktabs"));$(html).appendTo($("#split-host .split:last"))}else{$(id).replaceWith(html)}};function escapeSelector(s){return s.replace(/(:|\.|\[|\])/g,"\\$1").replace(/\//g,"-")}var drawTree=function(e){$(".kfilebrowsertab-open .fa.fa-angle-double-down").removeClass("hidden");$(".kfilebrowsertab-open .fa.fa-angle-double-up").addClass("hidden");var data=e;element.jstree("destroy");element.jstree({core:{data:data,multiple:false},plugins:["contextmenu","sort"],contextmenu:{items:function($node){if($node.icon==="jstree-file")return{};return{new:{label:"New",submenu:{subnewfile:{label:"File",action:function(data){var inst=$.jstree.reference(data.reference);var item=inst.get_node(data.reference);var id=$node.id;var nodePath=inst.get_path($node);nodePath[0]="./";var path=nodePath.join("");var name=window.prompt("What should the filename be?");if(name!==""||name!==null){var target=pathJoin([path,name],"/");filesocket.emit("create-file",target)}}},subnewfolder:{label:"Folder",action:function(data){var inst=$.jstree.reference(data.reference);var item=inst.get_node(data.reference);var id=$node.id;var nodePath=inst.get_path($node);var path=nodePath.join("");var name=window.prompt("What should the folder name be?");if(name!==""||name!==null){var target=pathJoin([path,name],"/")+"/";filesocket.emit("create-dir",target)}}}}}}}}});loadNewImage(currentTree,data);currentTree=data;element.bind("select_node.jstree",openNode);element.on("changed.jstree",loadEditor)};var loadNewImage=function(currentTree,data){if(data&&data.length>0&&data[0].children.length>0){var children=data[0].children;for(var i=0;i<children.length;i++){var c=children[i];var filename=c.text.toLowerCase();if(filename.indexOf(".pdf")>0||filename.indexOf(".png")>0){filesocket.emit("load-file",c.text)}}}};var notInCurrentTree=function(text,data){if(data&&data.length>0&&data[0].children.length>0){var children=data[0].children;for(var i=0;i<children.length;i++){var c=children[i];if(c.text.toLowerCase()===text.toLowerCase()){return false}}}return true};var openNode=function(evt,data){data.instance.toggle_node(data.node)};var get_filename=function(f){if(f.indexOf("/")>=0){var fsl=f.split("/");return fsl[fsl.length-1]}else{return f}};var prefix_file_tab_path=function(path){if(path.indexOf("./")===0)return path;else return"./"+path};var loadEditor=function(e,data){var isDirectory=data&&data.node&&data.node.text&&data.node.text.toString().endsWith&&data.node.text.toString().endsWith("/");if(isDirectory)return;var isRoot=data&&data.node&&data.node.parent==="#";if(isRoot)return;var id=data.node.id;var editorTabId=getUniqueFileId();var nodePath=data.instance.get_path(data.node);nodePath[0]="./";var path=nodePath.join("");var filename=$("#"+id).text();openFile(editorTabId,filename,path)};var getUniqueFileId=function(){return Math.round((new Date).getTime()).toString()};var openFile=function(id,filename,path){var options={id:escapeSelector(id),filename:filename,path:path,prefix_file_tab_path:prefix_file_tab_path,get_filename:get_filename};var containerId="#editor";var editorElement=$(containerId);var tab=$(".kfiletab[data-path='"+path+"']",editorElement);if(tab.length===0){var newIde=Handlebars.templates["ide.hbs"](options);var newTab=Handlebars.templates["file-tab.hbs"](options);$(newTab).appendTo($(".tabbar .ktabs",editorElement));$(newIde).appendTo(editorElement);var editorId="file"+options.id;editor=new Editor;editor.init(containerId,editorId,getSetting(options.filename),false);editors[path]=editor;displayLoadFileProgress(editorId);ensureFileExists(path);loadFile(path,editor);tab=$(".kfiletab[data-path='"+path+"']",editorElement);tab.find("a.tab-progress").removeClass("hidden");tab.find("a.close-tab").removeClass("hidden")}tab.click()};var getSetting=function(file){var filename=file.toLowerCase();if(filename==="makefile"){return"makefile"}else if(filename==="dockerfile"){return"dockerfile"}else if(filename.endsWith(".yml")){return"dockercompose"}else if(filename.endsWith(".cs")){return"csharp"}else if(filename.endsWith(".js")){return"javascript"}else if(filename.endsWith(".go")){return"golang"}return""};var ensureFileExists=function(path){filesocket.emit("create-file",path)};var loadFile=function(path){filesocket.emit("load-file",path)};var displayLoadFileProgress=function(editorId){$(".file-loading-progress#progress-"+editorId).removeClass("hidden")};var hideLoadFileProgress=function(){$(".file-loading-progress").remove()};var getWSURL=function(){var host=window.location.host;if(host.indexOf("katacoda")>=0){return"//editor-ws.katacoda.com"}return"//b2d:3811"}};var EditorTerminalTreeView=function(){var js_view,term_view;this.init=function(_options){options=_options||{};var tabbedView=new TabBarView;tabbedView.init();term_view=new TerminalViewLayout({tabview:tabbedView});var sync_editor_to_container=new SyncEditorToContainer(term_view);sync_editor_to_container.init();term_view.init(options);var jsTree=new JSTreeView({tabview:tabbedView});options.tree=$("#jstree");jsTree.init(options);js_view=new JsHtmlView;js_view.init()};this.next_step=function(id,step){term_view.next_step(id,step)};this.write=function(id,step){term_view.write(id,step)};this.write_to_environment=function(id,step){term_view.write_to_environment(id,step)};this.setCode=function(code){js_view.setCode(code)};this.getCode=function(){js_view.getCode()};this.validate_step_change=function(step){if(js_view&&js_view.validate_step_change){js_view.validate_step_change(step)}if(term_view&&term_view.validate_step_change){term_view.validate_step_change(step)}}};